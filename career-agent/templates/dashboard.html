<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Career Assistant · Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      :root {
        --c-bg: #090909;
        --c-surface: #0f0f10;
        --c-elev: #161618;
        --c-border: rgba(255, 255, 255, 0.07);
        --c-bh: rgba(255, 255, 255, 0.13);
        --c-accent: #f5c518;
        --c-adim: rgba(245, 197, 24, 0.12);
        --c-txt-1: #f2f2f2;
        --c-txt-2: #888;
        --c-txt-3: #444;
        --c-green: #22c55e;
        --c-red: #f87171;
        --c-blue: #60a5fa;
        --c-orange: #fb923c;
        --c-purple: #a78bfa;
        --r: 10px;
        --rlg: 14px;
        --rsm: 6px;
        --hh: 56px;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          "Inter",
          -apple-system,
          sans-serif;
        background: var(--c-bg);
        color: var(--c-txt-1);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
      }
      ::-webkit-scrollbar {
        width: 5px;
        height: 5px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #2a2a2a;
        border-radius: 99px;
      }

      /* TOPBAR */
      .topbar {
        position: sticky;
        top: 0;
        height: var(--hh);
        background: rgba(9, 9, 9, 0.9);
        backdrop-filter: blur(14px);
        border-bottom: 1px solid var(--c-border);
        display: flex;
        align-items: center;
        padding: 0 24px;
        z-index: 100;
        gap: 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
      }
      .brand-mark {
        width: 30px;
        height: 30px;
        background: var(--c-accent);
        border-radius: var(--rsm);
        display: grid;
        place-items: center;
        font-size: 0.85rem;
        font-weight: 900;
        color: #000;
        flex-shrink: 0;
      }
      .brand-name {
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--c-txt-1);
        letter-spacing: -0.02em;
      }
      .brand-tag {
        font-size: 0.68rem;
        color: var(--c-txt-3);
        margin-top: 1px;
      }
      .dv {
        width: 1px;
        height: 20px;
        background: var(--c-border);
        flex-shrink: 0;
      }
      .nav {
        display: flex;
        gap: 2px;
        flex: 1;
      }
      .nav a {
        padding: 5px 12px;
        border-radius: var(--rsm);
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--c-txt-2);
        text-decoration: none;
        transition:
          color 0.15s,
          background 0.15s;
      }
      .nav a:hover {
        color: var(--c-txt-1);
        background: rgba(255, 255, 255, 0.05);
      }
      .nav a.active {
        color: var(--c-txt-1);
        background: rgba(255, 255, 255, 0.08);
      }
      .ml-auto {
        margin-left: auto;
      }
      .btn-sm {
        background: transparent;
        border: 1px solid var(--c-border);
        border-radius: var(--rsm);
        padding: 5px 12px;
        font-size: 0.76rem;
        font-family: inherit;
        font-weight: 500;
        color: var(--c-txt-2);
        cursor: pointer;
        transition: all 0.15s;
      }
      .btn-sm:hover {
        border-color: var(--c-bh);
        color: var(--c-txt-1);
      }

      /* PAGE */
      .page {
        max-width: 1140px;
        margin: 0 auto;
        padding: 28px 24px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* STAT GRID */
      .stat-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }
      .stat-card {
        background: var(--c-surface);
        border: 1px solid var(--c-border);
        border-radius: var(--rlg);
        padding: 18px 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        transition: border-color 0.15s;
      }
      .stat-card:hover {
        border-color: var(--c-bh);
      }
      .stat-label {
        font-size: 0.68rem;
        font-weight: 700;
        letter-spacing: 0.07em;
        text-transform: uppercase;
        color: var(--c-txt-3);
      }
      .stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--c-txt-1);
        letter-spacing: -0.04em;
        line-height: 1;
      }
      .stat-value.good {
        color: var(--c-green);
      }
      .stat-value.warn {
        color: var(--c-orange);
      }
      .stat-value.bad {
        color: var(--c-red);
      }

      /* CHARTS ROW */
      .charts-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 12px;
      }
      .chart-card {
        background: var(--c-surface);
        border: 1px solid var(--c-border);
        border-radius: var(--rlg);
        padding: 20px;
      }
      .card-label {
        font-size: 0.68rem;
        font-weight: 700;
        letter-spacing: 0.07em;
        text-transform: uppercase;
        color: var(--c-txt-3);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 7px;
      }
      .card-label-dot {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: var(--c-accent);
        flex-shrink: 0;
      }

      /* CRITERIA */
      .crit-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
      }
      .crit-item {
        background: var(--c-surface);
        border: 1px solid var(--c-border);
        border-radius: var(--r);
        padding: 14px 16px;
      }
      .crit-name {
        font-size: 0.7rem;
        color: var(--c-txt-2);
        margin-bottom: 10px;
      }
      .bar-bg {
        background: var(--c-elev);
        border-radius: 99px;
        height: 5px;
        overflow: hidden;
        margin-bottom: 8px;
      }
      .bar-fill {
        height: 100%;
        border-radius: 99px;
        transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .crit-score {
        font-size: 0.85rem;
        font-weight: 800;
      }

      /* TABLE */
      .table-card {
        background: var(--c-surface);
        border: 1px solid var(--c-border);
        border-radius: var(--rlg);
        overflow: hidden;
      }
      .table-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--c-border);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
      }
      th {
        text-align: left;
        color: var(--c-txt-3);
        font-weight: 600;
        padding: 10px 16px;
        border-bottom: 1px solid var(--c-border);
        font-size: 0.68rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }
      td {
        padding: 11px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--c-txt-2);
        max-width: 260px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      td.strong {
        color: var(--c-txt-1);
        font-weight: 500;
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover td {
        background: rgba(255, 255, 255, 0.02);
      }

      .badge {
        display: inline-block;
        padding: 2px 9px;
        border-radius: 99px;
        font-size: 0.68rem;
        font-weight: 700;
      }
      .bg {
        background: rgba(34, 197, 94, 0.1);
        color: var(--c-green);
      }
      .by {
        background: rgba(251, 146, 60, 0.1);
        color: var(--c-orange);
      }
      .br {
        background: rgba(248, 113, 113, 0.1);
        color: var(--c-red);
      }
      .ba {
        background: var(--c-adim);
        color: var(--c-accent);
      }

      .empty {
        text-align: center;
        color: var(--c-txt-3);
        padding: 36px;
        font-size: 0.82rem;
      }

      /* FOOTER */
      footer {
        border-top: 1px solid var(--c-border);
        padding: 14px 24px;
        font-size: 0.68rem;
        color: var(--c-txt-3);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      footer a {
        color: var(--c-txt-3);
        text-decoration: none;
      }
      footer a:hover {
        color: var(--c-txt-2);
      }
      .footer-links {
        display: flex;
        gap: 14px;
      }

      @media (max-width: 820px) {
        .stat-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .charts-row {
          grid-template-columns: 1fr;
        }
        .crit-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <!-- TOPBAR -->
    <header class="topbar">
      <a class="brand" href="/">
        <div class="brand-mark">✦</div>
        <div>
          <div class="brand-name">Career Assistant</div>
          <div class="brand-tag">GPT-4o-mini + RAG</div>
        </div>
      </a>
      <div class="dv"></div>
      <nav class="nav">
        <a href="/">Agent</a>
        <a href="/dashboard" class="active">Dashboard</a>
        <a href="/docs">API Docs</a>
      </nav>
      <button class="btn-sm ml-auto" onclick="loadData()">↻ Refresh</button>
    </header>

    <div class="page">
      <!-- STAT CARDS -->
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-label">Total Interactions</div>
          <div class="stat-value" id="total-count">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg. Score</div>
          <div class="stat-value" id="avg-score">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Human Interventions</div>
          <div class="stat-value" id="human-count">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Last Score</div>
          <div class="stat-value" id="last-score">—</div>
        </div>
      </div>

      <!-- CHARTS -->
      <div class="charts-row">
        <div class="chart-card">
          <div class="card-label">
            <span class="card-label-dot"></span>Score History · Last 20
          </div>
          <canvas id="scoreHistory" height="80"></canvas>
        </div>
        <div class="chart-card">
          <div class="card-label">
            <span class="card-label-dot"></span>Message Type Distribution
          </div>
          <canvas id="typeChart"></canvas>
        </div>
      </div>

      <!-- CRITERIA BARS -->
      <div class="chart-card">
        <div class="card-label">
          <span class="card-label-dot"></span>Last Response — Criteria Scores
        </div>
        <div class="crit-grid" id="criteria-bars">
          <div class="empty">No data yet</div>
        </div>
      </div>

      <!-- LOG TABLE -->
      <div class="table-card">
        <div class="table-head">
          <div class="card-label" style="margin-bottom: 0">
            <span class="card-label-dot"></span>Recent Interactions
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Sender</th>
              <th>Type</th>
              <th>Score</th>
              <th>Attempts</th>
              <th>Message Preview</th>
            </tr>
          </thead>
          <tbody id="log-tbody">
            <tr>
              <td colspan="6" class="empty">Loading…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <footer>
      <span>Career Assistant AI Agent · v1.1</span>
      <div class="footer-links">
        <a href="/">Agent</a>
        <a href="/docs">Swagger API</a>
      </div>
    </footer>

    <script>
      let histChart = null;
      let typeChart = null;

      const CRIT_LABELS = {
        professional_tone: "Professional Tone",
        clarity: "Clarity",
        completeness: "Completeness",
        safety: "Safety",
        relevance: "Relevance",
      };

      function scoreColor(v, max = 10) {
        const r = v / max;
        if (r >= 0.7) return "#22c55e";
        if (r >= 0.5) return "#fb923c";
        return "#f87171";
      }
      function badgeCls(s) {
        if (s >= 7) return "bg";
        if (s >= 5) return "by";
        return "br";
      }
      function fmt(ts) {
        if (!ts) return "—";
        return new Date(ts).toLocaleString("en-US", {
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      async function loadData() {
        try {
          const res = await fetch("/logs");
          const logs = await res.json();

          const evaluated = logs.filter((l) => l.evaluation);
          const humans = logs.filter(
            (l) => l.action === "human_intervention_requested",
          );

          document.getElementById("total-count").textContent = logs.length;
          document.getElementById("human-count").textContent = humans.length;

          if (evaluated.length) {
            const avg =
              evaluated.reduce((s, l) => s + l.evaluation.total_score, 0) /
              evaluated.length;
            const last = evaluated.at(-1).evaluation.total_score;

            const avgEl = document.getElementById("avg-score");
            avgEl.textContent = avg.toFixed(1);
            avgEl.className =
              "stat-value " + (avg >= 7 ? "good" : avg >= 5 ? "warn" : "bad");

            const lastEl = document.getElementById("last-score");
            lastEl.textContent = last + "/10";
            lastEl.className =
              "stat-value " + (last >= 7 ? "good" : last >= 5 ? "warn" : "bad");

            // Criteria bars
            const lastScores = evaluated.at(-1).evaluation.scores;
            if (lastScores) {
              const cont = document.getElementById("criteria-bars");
              cont.innerHTML = "";
              Object.entries(CRIT_LABELS).forEach(([key, label]) => {
                const val = lastScores[key] ?? 0;
                const pct = (val / 2) * 100;
                const col = scoreColor(val, 2);
                cont.innerHTML += `
                  <div class="crit-item">
                    <div class="crit-name">${label}</div>
                    <div class="bar-bg">
                      <div class="bar-fill" style="width:0%;background:${col}" data-pct="${pct}"></div>
                    </div>
                    <div class="crit-score" style="color:${col}">${val}/2</div>
                  </div>`;
              });
              requestAnimationFrame(() => {
                document
                  .querySelectorAll(".bar-fill[data-pct]")
                  .forEach((el) => {
                    el.style.width = el.dataset.pct + "%";
                  });
              });
            }

            // History chart
            const last20 = evaluated.slice(-20);
            const labels = last20.map((_, i) => "#" + (i + 1));
            const scores = last20.map((l) => l.evaluation.total_score);
            if (histChart) histChart.destroy();
            histChart = new Chart(document.getElementById("scoreHistory"), {
              type: "line",
              data: {
                labels,
                datasets: [
                  {
                    label: "Evaluator Score",
                    data: scores,
                    borderColor: "rgba(245,197,24,.8)",
                    backgroundColor: "rgba(245,197,24,.06)",
                    fill: true,
                    tension: 0.35,
                    pointBackgroundColor: scores.map((s) => scoreColor(s)),
                    pointRadius: 5,
                    pointHoverRadius: 7,
                  },
                ],
              },
              options: {
                plugins: { legend: { display: false } },
                scales: {
                  y: {
                    min: 0,
                    max: 10,
                    ticks: { color: "#444" },
                    grid: { color: "rgba(255,255,255,.04)" },
                  },
                  x: {
                    ticks: { color: "#444" },
                    grid: { color: "rgba(255,255,255,.04)" },
                  },
                },
              },
            });
          } else {
            document.getElementById("avg-score").textContent = "—";
            document.getElementById("last-score").textContent = "—";
          }

          // Type donut
          const typeCounts = {};
          logs.forEach((l) => {
            const t = l.message_type || "unknown";
            typeCounts[t] = (typeCounts[t] || 0) + 1;
          });
          if (typeChart) typeChart.destroy();
          typeChart = new Chart(document.getElementById("typeChart"), {
            type: "doughnut",
            data: {
              labels: Object.keys(typeCounts),
              datasets: [
                {
                  data: Object.values(typeCounts),
                  backgroundColor: [
                    "#f5c518",
                    "#22c55e",
                    "#60a5fa",
                    "#f87171",
                    "#a78bfa",
                    "#34d399",
                  ],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { color: "#666", font: { size: 11 }, padding: 12 },
                },
              },
              cutout: "62%",
            },
          });

          // Table
          const tbody = document.getElementById("log-tbody");
          const recent = [...logs].reverse().slice(0, 15);
          if (!recent.length) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty">No interactions yet</td></tr>';
            return;
          }
          tbody.innerHTML = recent
            .map((l) => {
              const score = l.evaluation ? l.evaluation.total_score : null;
              const badge =
                score != null
                  ? `<span class="badge ${badgeCls(score)}">${score}/10</span>`
                  : `<span class="badge ba">human</span>`;
              const preview = (l.message || "").slice(0, 55) + "…";
              return `<tr>
              <td>${fmt(l.timestamp)}</td>
              <td class="strong">${l.sender || "—"}</td>
              <td>${l.message_type || l.action || "—"}</td>
              <td>${badge}</td>
              <td>${l.attempts || "—"}</td>
              <td title="${(l.message || "").replace(/"/g, "&quot;")}">${preview}</td>
            </tr>`;
            })
            .join("");
        } catch (err) {
          console.error("Failed to load data:", err);
        }
      }

      loadData();
      setInterval(loadData, 30000);
    </script>
  </body>
</html>
