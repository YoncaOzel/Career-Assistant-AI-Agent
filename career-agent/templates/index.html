<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Career Assistant AI Agent</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f0f2f5;
        color: #333;
      }

      header {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        color: #fff;
        padding: 24px 32px;
      }
      header h1 {
        font-size: 1.6rem;
      }
      header p {
        margin-top: 4px;
        font-size: 0.9rem;
        opacity: 0.75;
      }

      main {
        max-width: 860px;
        margin: 32px auto;
        padding: 0 16px;
        display: grid;
        gap: 24px;
      }

      .card {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      }
      .card h2 {
        font-size: 1.1rem;
        margin-bottom: 16px;
        color: #1a1a2e;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-size: 0.85rem;
        font-weight: 600;
      }
      input,
      textarea {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 0.95rem;
        transition: border 0.2s;
      }
      input:focus,
      textarea:focus {
        outline: none;
        border-color: #1a1a2e;
      }
      textarea {
        min-height: 130px;
        resize: vertical;
      }

      button {
        margin-top: 16px;
        background: #1a1a2e;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 28px;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover {
        background: #0f3460;
      }
      button:disabled {
        background: #aaa;
        cursor: not-allowed;
      }

      #status-bar {
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        display: none;
      }
      .status-info {
        background: #e8f4fd;
        color: #1565c0;
      }
      .status-success {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .status-warning {
        background: #fff8e1;
        color: #f57f17;
      }
      .status-error {
        background: #ffebee;
        color: #c62828;
      }

      #result {
        display: none;
      }

      .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
      }
      .badge-blue {
        background: #e3f2fd;
        color: #1565c0;
      }
      .badge-green {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .badge-red {
        background: #ffebee;
        color: #c62828;
      }
      .badge-orange {
        background: #fff3e0;
        color: #e65100;
      }

      .score-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }
      .score-item {
        background: #f7f9fc;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
      }
      .score-item .num {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1a1a2e;
      }
      .score-item .lbl {
        font-size: 0.75rem;
        color: #666;
        margin-top: 2px;
      }

      .response-box {
        background: #f7f9fc;
        border-radius: 8px;
        padding: 16px;
        white-space: pre-wrap;
        line-height: 1.65;
        font-size: 0.92rem;
        border-left: 4px solid #1a1a2e;
      }

      .meta {
        font-size: 0.8rem;
        color: #888;
        margin-top: 8px;
      }

      #log-list {
        list-style: none;
      }
      #log-list li {
        background: #f7f9fc;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 8px;
        font-size: 0.85rem;
      }
      #log-list li strong {
        color: #1a1a2e;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>ü§ñ Career Assistant AI Agent</h1>
      <p>
        ƒ∞≈üveren mesajlarƒ±na otomatik profesyonel yanƒ±t √ºretir ¬∑ FastAPI +
        GPT-4o-mini
      </p>
    </header>

    <main>
      <!-- INPUT CARD -->
      <div class="card">
        <h2>üì® Yeni ƒ∞≈üveren Mesajƒ±</h2>

        <label for="sender">G√∂nderen ƒ∞sim / ≈ûirket</label>
        <input id="sender" type="text" placeholder="√∂r: TechCorp HR" />

        <label for="msg" style="margin-top: 14px">Mesaj</label>
        <textarea
          id="msg"
          placeholder="ƒ∞≈üverenin g√∂nderdiƒüi mesajƒ± buraya yapƒ±≈ütƒ±r..."
        ></textarea>

        <button id="send-btn" onclick="sendMessage()">üöÄ Yanƒ±t √úret</button>

        <div id="status-bar"></div>
      </div>

      <!-- RESULT CARD -->
      <div id="result" class="card">
        <h2>‚úÖ Sonu√ß</h2>

        <div
          id="badges"
          style="margin-bottom: 16px; display: flex; gap: 8px; flex-wrap: wrap"
        ></div>

        <div id="response-text" class="response-box"></div>

        <div id="eval-section" style="margin-top: 20px; display: none">
          <strong>Evaluator Puanlarƒ±</strong>
          <div id="score-grid" class="score-grid"></div>
          <p id="feedback-text" class="meta" style="margin-top: 8px"></p>
        </div>

        <p id="meta-text" class="meta" style="margin-top: 12px"></p>
      </div>

      <!-- LOGS CARD -->
      <div class="card">
        <h2>üìã Son Etkile≈üimler</h2>
        <button
          onclick="loadLogs()"
          style="margin-top: 0; padding: 8px 18px; font-size: 0.85rem"
        >
          Yenile
        </button>
        <ul id="log-list" style="margin-top: 14px"></ul>
      </div>
    </main>

    <script>
      async function sendMessage() {
        const sender = document.getElementById("sender").value.trim();
        const msg = document.getElementById("msg").value.trim();

        if (!sender || !msg) {
          showStatus(
            "L√ºtfen g√∂nderen ve mesaj alanlarƒ±nƒ± doldurun.",
            "warning",
          );
          return;
        }

        const btn = document.getElementById("send-btn");
        btn.disabled = true;
        btn.textContent = "‚è≥ ƒ∞≈üleniyor...";
        showStatus(
          "Agent √ßalƒ±≈üƒ±yor ‚Äî yanƒ±t √ºretiliyor, deƒüerlendiriliyor...",
          "info",
        );
        document.getElementById("result").style.display = "none";

        try {
          const res = await fetch("/process-message", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sender_name: sender, message: msg }),
          });
          const data = await res.json();

          if (!res.ok) throw new Error(data.detail || "Sunucu hatasƒ±");

          renderResult(data);
          showStatus("", "info");
          loadLogs();
        } catch (e) {
          showStatus("Hata: " + e.message, "error");
        } finally {
          btn.disabled = false;
          btn.textContent = "üöÄ Yanƒ±t √úret";
        }
      }

      function renderResult(data) {
        const resultEl = document.getElementById("result");
        resultEl.style.display = "block";

        // Badges
        const badgesEl = document.getElementById("badges");
        badgesEl.innerHTML = "";

        const statusBadge =
          data.status === "sent"
            ? `<span class="badge badge-green">‚úÖ G√∂nderildi</span>`
            : `<span class="badge badge-red">üö® ƒ∞nsan Gerekli</span>`;
        badgesEl.innerHTML += statusBadge;

        if (data.message_type) {
          badgesEl.innerHTML += `<span class="badge badge-blue">${data.message_type}</span>`;
        }
        if (data.attempts) {
          badgesEl.innerHTML += `<span class="badge badge-orange">Deneme: ${data.attempts}</span>`;
        }

        // Response text
        const responseEl = document.getElementById("response-text");
        if (data.status === "human_required") {
          responseEl.textContent = `‚ö†Ô∏è  ƒ∞nsan m√ºdahalesi gerekiyor.\n\nKategori: ${data.category}\nSebep: ${data.reason}`;
        } else {
          responseEl.textContent = data.response;
        }

        // Eval scores
        const evalSection = document.getElementById("eval-section");
        if (data.evaluation) {
          evalSection.style.display = "block";
          const scoreGrid = document.getElementById("score-grid");
          scoreGrid.innerHTML = "";
          const labels = {
            professional_tone: "Profesyonel Ton",
            clarity: "Netlik",
            completeness: "Eksiksizlik",
            safety: "G√ºvenlik",
            relevance: "Alaka",
          };
          Object.entries(data.evaluation.scores).forEach(([k, v]) => {
            scoreGrid.innerHTML += `
          <div class="score-item">
            <div class="num">${v}/2</div>
            <div class="lbl">${labels[k] || k}</div>
          </div>`;
          });
          scoreGrid.innerHTML += `
        <div class="score-item" style="background:#e8f5e9;">
          <div class="num" style="color:#2e7d32;">${data.evaluation.score}/10</div>
          <div class="lbl">Toplam</div>
        </div>`;

          document.getElementById("feedback-text").textContent =
            data.evaluation.feedback || "";
        } else {
          evalSection.style.display = "none";
        }

        document.getElementById("meta-text").textContent = data.attempts
          ? `${data.attempts} denemede tamamlandƒ±.`
          : "";
      }

      function showStatus(msg, type) {
        const el = document.getElementById("status-bar");
        el.className = `status-${type}`;
        el.textContent = msg;
        el.style.display = msg ? "block" : "none";
      }

      async function loadLogs() {
        try {
          const res = await fetch("/logs");
          const logs = await res.json();
          const ul = document.getElementById("log-list");
          ul.innerHTML = "";

          if (!logs.length) {
            ul.innerHTML = "<li>Hen√ºz etkile≈üim kaydƒ± yok.</li>";
            return;
          }

          logs
            .slice()
            .reverse()
            .slice(0, 10)
            .forEach((log) => {
              const ti = new Date(log.timestamp).toLocaleString("tr-TR");
              ul.innerHTML += `
          <li>
            <strong>${log.sender || "?"}</strong> &nbsp;¬∑&nbsp;
            ${log.message_type || log.action || ""} &nbsp;¬∑&nbsp;
            Puan: ${log.evaluation?.total_score ?? "‚Äî"}/10 &nbsp;¬∑&nbsp;
            <span style="color:#aaa;">${ti}</span>
          </li>`;
            });
        } catch {
          /* sessiz ge√ß */
        }
      }

      // Sayfa a√ßƒ±lƒ±nda loglarƒ± y√ºkle
      loadLogs();
    </script>
  </body>
</html>
